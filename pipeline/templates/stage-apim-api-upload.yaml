parameters:
  - name: apiName
    displayName: Target API Name (case sensitive)
    type: string
  - name: storageAccountName
    displayName: Storage Account ARM Templates
    type: string
  - name: storageAccountResourceGroupName
    displayName: Storage Account Resource Group
    type: string
  - name: containerName
    displayName: Storage Account Container ARM Tempaltes
    type: string
  - name: templatePath
    displayName: Storage Account relative template path
    type: string
  - name: localTemplateDirectory
    displayName: Local Template Directory
    type: string
  - name: azSubscription
    type: string

stages:    
- stage: uploadStorageTemplates
  displayName : Upload API ARM Templates
  jobs:
    - job:
      displayName: Storage Account Upload
      pool:
        vmImage: ubuntu-16.04
      variables:
        - name: API_NAME
          value: ${{ parameters.apiName }}
        - name: STORAGE_ACCOUNT
          value: ${{ parameters.storageAccountName }}
        - name: STORAGE_RESOURCE_GROUP
          value: ${{ parameters.storageAccountResourceGroupName }}
        - name: CONTAINER
          value: ${{ parameters.containerName }}
        - name: REMOTE_TEMPLATE_PATH
          value: ${{ parameters.templatePath }}
        - name: LOCAL_TEMPLATE_DIRECTORY
          value: ${{ parameters.localTemplateDirectory }}
      steps:
      - task: AzureCLI@2
        displayName: Azure CLI - Storage Account Upload
        inputs:
          azureSubscription: ${{ parameters.azsubscription }}
          scriptType: bash
          scriptLocation: scriptPath
          scriptPath: $(System.DefaultWorkingDirectory)/pipeline/scripts/apim-api-upload.sh
          
      - publish: $(System.DefaultWorkingDirectory)/pipeline/scripts/apim-api-deploy.sh
        artifact: Scripts
      - publish: $(System.DefaultWorkingDirectory)/api/${{ parameters.apiName }}
        artifact: Templates