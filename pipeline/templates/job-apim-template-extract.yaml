parameters:
- name: apiName
  displayName: API Name
  type: string
- name: targetTemplatePath
  displayName: Root repo path to create the API folder and template files
  type: string
- name: azSubscription
  displayName: Azure Service Connection
  type: string
- name: sourceApim
  type: string
  default: PWS-SYD-APIM-DEV-CICD
- name: sourceApimResourceGroup
  type: string
  default: PWS-SYD-ARG-CICD

resources:
  repositories:
    - repository: tools
      type: github
      name: mrsmitty/apim-devops
      ref: refs/heads/users/ps/extends
      endpoint: Integration

jobs:
- job: extractApim
  displayName: Extract APIM Template
  pool:
    vmImage: ubuntu-latest
  variables:
    - name: SOURCE_APIM
      value: ${{ parameters.sourceApim }}
    - name: DEST_APIM
      value: WAR-MOCK-APIM
    - name: API_NAME
      value: ${{ parameters.apiName }}
    - name: RESOURCE_GROUP
      value: ${{ parameters.sourceApimResourceGroup }}
    - name: TEMPLATE_DIRECTORY
      value: ${{ parameters.targetTemplatePath }}/${{ parameters.apiName }}
    - name: SOURCE_BRANCH
      value: $(Build.SourceBranch)

  steps:
  - checkout: tools
    path: tools

  - checkout: self
    persistCredentials: true
    
  - task: AzureCLI@2
    displayName: AZ CLI - Extract APIM Template
    inputs:
      azureSubscription: ${{ variables.azSubscription }}
      scriptType: bash
      scriptLocation: scriptPath
      scriptPath: $(System.DefaultWorkingDirectory)/pipeline/scripts/apim-template-extract.sh
